# 2.2.1 TCP/IP의 계층구조

TCP/IP는 네트워크 프로토콜 스위트로, 온라인상의 안전하고 효울적인 데이터 전송의 필수 요건을 정의한다.

`인터넷 프로토콜(IP; Internet Protocol)`은 인터넷의 주소체계로, 소스 장치에서 대상 장치로 정보 패킷을 전달하는 것이 핵심 기능이다. IP는 네트워크 연결이 이루어지는 기본적인 방법이다.

한편, IP는 패킷 순서 지정 또는 오류 검사를 처리하지 않는데, 이러한 기능은 또 다른 프로토콜을 필요로 하며 대개의 경우 `전송제어 프로토콜(TCP; Transmission Control Protocol)`이 그 역할을 한다.

데이터 전송 과정에서 TCP와 IP는 각각 담당하는 작업이 있지만, 결국 같은 결과를 목표로 하기 때문에 한 명칭으로 알려져 있다.

TCP/IP의 각 계층은 프로토콜의 네트워킹 범위에 따라 4개로 나뉜다.

<img src="../../assets/2.2.1/tcpip.png" width="300px" height="600px">
<br />

### | 애플리케이션 계층 (application layer)

해당 프로토콜은 앱에 구축되기 때문에 사용자가 상호작용하기 가장 쉬운 계층이며, 서비스를 실질적으로 사람들에게 제공한다.

- `FTP` : 장치와 장치 간의 파일을 전송하는데 사용되는 표준 통신 프로토콜
- `SSH` : 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 암호하 네트워크 프로토콜
- `HTTP` : www을 이용하기 위한 데이터 통신의 기초이자, 웹 사이트를 이용하는데 쓰는 프로토콜
- `SMTP` : 전자 메일 전송을 위한 인터넷 표준 통신 프로토콜
- `DNS` : 도메인 이름과 IP 주소를 매핑해주는 서버. 이를 통해 IP 주소가 바뀌어도 사용자들에게 똑같은 도메인 주소로 서비스할 수 있다.

<br />

### | 전송 계층 (transport layer)

송신자와 수신자를 연결하는 통신 서비스를 제공하며 연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공할 수 있으며 애플리케이션과 인터넷 계층 사이의 데이터가 전달될 때 중계 역할을 한다.

대표적으로 TCP와 UDP가 있다.

`TCP`는 패킷 사이의 순서를 보장하고, 연결지향 프로토콜을 사용하여 수신 여부를 확인하는 '가상회선 패킷 교환 방식'을 사용한다.

- 가상 회선 패킷 교환 방식이란 관련된 패킷을 전부 같은 경로로 전송하는 방법으로, 각 패킷에는 가상 회선 식별자가 포함되며 모든 패킷을 전송하면 가상 회선이 해제되고 패킷들은 전송된 순서대로 도착하는 방식을 말한다.

`UDP`는 순서를 보장하지 않고 수신 여부를 확인하지 않으며, 단순히 데이터만 주는 '데이터그램 패킷 교환 방식'을 사용한다.

- 데이터 그램 패킷 교환 방식이란 패킷이 독립적으로 이동하며 최적의 경로를 선택하여 전송된다. 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있으며, 도착한 순서는 다를 수 있다.

<b> _TCP 연결 성립 과정_ </b>

TCP는 신뢰성을 확보할 때 `3-way handshake` 작업을 진행하며, 클라이언트와 서버가 통신할 때 아래와 같은 세 단계를 거친다.

<img src="../../assets/2.2.1/3way.jpeg" weight="300px" height="300px">

(1) `SYN(synchronization) 단계` : 대화를 시작할 수 있도록 클라이언트가 SYN 최초 요청 패킷을 대상 서버로 보낸다.

이때 ISN(initial sequence number)를 담아보내는데, 이는 새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호를 말하며, 이는 장치마다 다를 수 있다.

(2) `SYN + ACK 단계` : 대상 서버가 SYN-ACK 패킷을 보내 이 과정에 동의한다.

즉, 서버는 클라이언트의 SYN을 수신하고 서버의 ISN과 승인번호로 클라이언트의 ISN + 1을 전송한다.

(3) `ACK(acknowledgement) 단계` : 소스가 대상에 ACK 패킷을 보내 이 과정을 확인하며, 이후 메시지 콘텐츠를 전송한다.

클라이언트는 서버의 ISN + 1값을 승인번호로 하여 ACK를 서버에 전송한다.

이렇게 3-way handshake 과정 이후 신뢰성이 구축되고, 데이터 전송을 시작한다. TCP는 이러한 과정이 있기 때문에 신뢰성이 있는 계층이라고 하며, UDP는 이 과정이 없기 때문에 신뢰성이 없는 계층이라고 한다.

<br />

<b> _TCP 연결 해제 과정_ </b>

TCP가 연결을 해제할 때는 `4-way handshake` 과정이 발생한다.

<img src="../../assets/2.2.1/4way.jpeg" width="300px" height="300px">

(1) FIN : 연결을 닫기 위해 클라이언트는 FIN 으로 설정된 세그먼트(TCP를 이용하여 전송되는 데이터 단위)를 보낸다. 이후 클라이언트는 FIN_WAIT_1 상태로 서버의 응답을 기다린다.

(2) ACK : 서버는 클라이언트에 ACK 이라는 승인 세그먼트를 보낸다. 이후 CLOSE_WAIT 상태가 된다. 클라이언트는 서버로부터 세그먼트를 받고 FIN_WAIT_2 상태가 된다.

(3) FIN : 서버는 ACK를 보낸 후 일정 시간 이후에 클라이언트에 FIN 이라는 세그먼트를 보낸다.

(4) ACK : 클라이언트는 TIME_WAIT 상태가 되고, 다시 서버로 ACK를 보내 서버는 CLOSED 상태가 된다. 이후 클라이언트는 어느 정도의 시간을 대기한 후 연결을 닫고 클라이언트와 서버의 모든 자원의 연결이 해제된다.

```
🍒 왜 굳이 일정 시간 후에 연결을 닫을까 ? (TIME_WAIT; 소켓이 소멸되지 않고 일정 시간 유지되는 상태)

1) 지연 패킷이 발생한 경우를 대비하기 위함이다.
패킷이 뒤늦게 도달하고 이를 처리하지 못한다면 데이터의 정확성과 일관성을 유지 및 보증할 수 없다.

2) 두 장치의 연결이 닫혔는지 확인하기 위함이다.
만약 LAST_ACK 상태에서 닫히게 되면, 다시 새로운 연결을 하려고 할 대 장치는 줄곧 LAST_ACK 상태이기 때문에 접속 오류가 날 수 있다.
```

<br />

### | 인터넷 계층 (internet layer)

장치로부터 받은 네트워크 패킷을 IP주소로 지정된 목적지로 전송하기 위해 사용되는 계층이다.

IP, ARP, ICMP 등이 있으며 패킷을 수신해야 할 상대의 주소를 지정하여 데이터를 전달한다. 한편, 상대방이 제대로 받았는지에 대해서는 보장하지 안는 비연결형적인 특징을 가지고 있다.

<br />

### | 링크 계층 (link layer)

전선, 광섬유, 무선 등을 통해 실질적으로 데이터를 전달하며, 장치 간에 신호를 주고받는 '규칙'을 정한다. 네트워크 접근 계층이라고도 한다.

이를 물리 계층과 데이터 링크 계층으로 나누기도 한다.

- `물리 계층`은 무선 LAN과 유선 LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층이다.
- `데이터링크 계층`은 '이더넷 프레임'을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층이다.

<br />

<b> _유선 LAN(IEEE802.3)_ </b>

유선랜을 이루는 이더넷은 IEEE802.3이라는 프로토콜을 따르며, 전이중화 통신을 쓴다.

`전이중화 통신(full duplex)` 란, 양쪽 장치가 동시에 송수신할 수 있는 방식을 가리킨다. 송신로와 수신로로 나누어 데이터를 주고받으며, 현대의 고속 이더넷은 해당 방식을 기반으로 통신한다.

따라서 충돌 가능성이 존재하지 않으므로 총돌을 감지하거나 방지하는 메커니즘이 필요하지 않다.

<b> _무선 LAN(IEEE802.11)_ </b>

무선랜 장치는 수신과 송신에 같은 채널을 사용하기 때문에 반이중화 통신을 사용한다.

`반이중화 통신(half duplex)`은 양쪽 장치는 서로 통신할 수 있지만, 동시에는 통신할 수 없으며 한 번에 한 방향만 통신할 수 있는 방식이다.

일반적으로 장치가 신호를 수신하기 시작하면 전송이 완료될 때 까지 기다린 후, 응답한다. 또한 둘 이상의 장치가 동시에 전송하면 충돌이 발생하여 메시지가 손실되거나 왜곡될 수 있기 때문에 충돌 방지 시스템이 필요하다.

무선랜(Wireless Local Area Network)은 무선 신호 전달 방식을 이용하여 2대 이상의 장치를 연결하는 기술이다.

<img src="../../assets/2.2.1/bssess.png" width="400px" height="300px">

- `BSS(Basic Service Set)` : 무선 서비스가 가능한 제한된 공간에서 기본적인 무선 장치들로 구성된 랜환경이다. 하나의 AP(무선 접속 장치; access point)를 기반으로 근거리 무선 통신이 구축되어 있어, 사용자가 한 곳에서 다른 곳으로 자유롭게 이동하며 네트워크에 접속하는 것은 불가능하다.
  AP의 존재 여부에 따라 두 가지로 나눌 수 있는데, AP가 있는 Infrastructure mode는 대표적으로 와이파이가 있고, AP가 없는 Ad hoc mode는 블루투스가 있다.
- `ESS(Extended Service Set)` : 유무선랜으로 구성된 네트워크로, 장거리 무선 통신을 제공하며 BSS보다 더 많은 가용성과 이동성을 지원한다. 즉, 사용자는 한 장소에서 다른 장소로 이동하며 중단 없이 네트워크에 계속 연결할 수 있다.

<br />

<b> _이더넷 프레임_ </b>

데이터 링크 계충운 이더넷 프레임을 통해 전달받은 데이터의 에러를 검출하고 캡슐화 한다.

<img src="../../assets/2.2.1/ithernetframe.png" width="600px" height="200px">

- preamble : 이더넷 프레임이 시작임을 알린다.
- SFD(start frame delimiter) : 다음 바이트부터 MAC 주소 필드가 시작됨을 알린다.
- DMAC, SAMC : 수신, 송신 MAC 주소를 말한다.
- EtherType : 인터넷 계층의 IP 프로토콜을 정의한다.
- Payload : 전달받은 데이터
- CRC : 에러 확인 비트

```
🥸 MAC주소 란 ?
컴퓨터나 노트북 등 각 장치에는 네트워크에 연결하기 위한 장치(LAN 카드)가 있는데, 이를 구별하기 위한 식별번호를 말한다.
6바이트(48비트)로 구성된다.
```

<br />

### 계층간 데이터 송수신 과정

<img src="../../assets/2.2.1/oracle.png" width="400px" height="300px">

- 애플리케이션 계층 : 통신이 시작되는 위치
- 전송 계층 : 데이터 캡슐화가 시작되는 위치
- 인터넷 계층 : 패킷 배달이 준비되는 위치. 세그먼트 및 패킷의 형식을 IP 데이터그램이라는 단위로 지정하여 데이터 전송을 준비한다.
- 데이터 링크 계층 : 프레이밍이 발생하는 위치
- 물리적 네트워크 계층 : 프레임이 송수신 되는 위치

### PDU(protocol data unit)

네트워크의 어떠한 계층에서 계층으로 데이터가 전달될 때 한 덩어리의 단위를 가리킨다.

PDU는 제어 관련 정보들이 포함된 `헤더`, 데이터를 의미하는 `페이로드`로 구성되어 있으며, 계층마다 부르는 명칭이 다르다.

- 애플리케이션 계층 : 메시지
- 전송 계층 : 세그먼트(TCP), 데이터그램(UDP)
- 인터넷 계층 : 패킷
- 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)

<b> _HTTP 요청을 통한 PDU 테스팅_ </b>

```cmd
% curl -v http://github.com
*   Trying 20.200.245.247:80...
* Connected to github.com (20.200.245.247) port 80 (#0)
> GET / HTTP/1.1
> Host: github.com
> User-Agent: curl/7.79.1
> Accept: */*
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 301 Moved Permanently
< Content-Length: 0
< Location: https://github.com/
<
* Connection #0 to host github.com left intact
```

위와 같이 애플리케이션 계층에서 응답이 모두 문자열인 이유는, 헤더에 authorization 값 등 다른 값들을 넣는 확장이 쉽기 때문이다.

한편, PDU 중 비트로 송수신 하는 것이 모든 데이터 단위 중 가장 빠르고 효율성이 높다.
