# 4.7.3 해시조인

### | 개요

해시 테이블을 기반으로 하는 조인 방식이다.

두 개의 테이블을 조인할 때, 하나의 테이블이 메모리에 온전히 올락간다면 보통 중첩 루프 조인보다 더 효율적이다. (메모리에 올릴 수 없을 정도의 대용량이라면 디스크를 사용하는 비용 발생)

동등(=) 조인에서만 사용할 수 있다.

### | 적합한 경우

1. JOIN 컬럼에 적당한 인덱스가 없어 중첩루프조인이 비효율적일 때
2. JOIN access량이 많아 랜덤 접근이 많이 발생하여 중첩루프조인이 비효율적일 때
3. 정렬병합조인을 하기에는 두 테이블의 용량이 커서 정렬 부하가 심할 때
4. 수행 빈도가 낮고 쿼리 수행시간이 오래 걸리는 대용량 테이블을 JOIN할 때

### | 해시조인 단계

MySQL을 기준으로 다음과 같다.

<b> _빌드 단계_ </b>

입력 테이블 중 크기가 더 작은 것을 기반으로 메모리 내 해시 테이블을 빌드하는 단계이다.

이때 조인에 사용되는 컬럼은 해시 테이블의 키로 사용된다.

> person과 country 라는 테이블이 있을 때, country 테이블의 용량이 더 작다고 가정하자.  
> 이때 조인에 사용되는 컬럼은 country.country_code이다.

<b> _프로브 단계_ </b>

레코드를 읽기 시작하며, 각 레코드에서 해시 키에 일치하는 레코를 찾아 결과값으로 반환한다.

> person 테이블에서 조인 조건을 만족하는(country.country_code = person.country_code) 레코드를 찾아 결과값으로 반환한다.

이를 통해 각 테이블은 한 번씩만 읽게 되므로, NLJ보다 성능이 더 좋다.

이때 사용 가능한 메모리 양은 시스템 변수 `join_buffer_size`에 의해 제어되며, 런타임 시 조정할 수 있다.
